{#

DATA FIELDS
  current_data: dict
  schema: dict
  fields: Optional[list]                # An optional list of fields to enable
                                        # is not part of a user's ACL
  root_key: Optional[str]               # A string to encapsulate a name in,
                                        # i.e. a root_key "profile" for a field "email" becomes "profile.email"

#}

{% for k, v in schema.items() if (k in fields or not fields) %}
  {% set form_id = generate_form_id(k) %}
  {% set field_name = root_key ~ "." ~ k if root_key else k %}

  {% if v.type in ["text", "email", "number"] %}
    <fieldset data-loading-disable>
      <label for="{{ form_id }}">{{ L[v.title] }}</label>
      <input {{ v.input_extra|safe }} id="{{ form_id }}"
        name="{{ field_name }}"
        type="{{ v.type }}"
        value="{% if current_data[k] == None %}{{ v.default or '' }}{% else %}{{ current_data[k] }}{% endif %}">
      {% if v.description %}
      <small>{{ L[v.description|safe] }}</small>
      {% endif %}
    </fieldset>

  {% elif v.type == "location" %}

    <fieldset autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-loading-disable data-field-type="location">
      <label>{{ L[v.title] }}</label>

      {% if v.description %}
      <small>{{ L[v.description|safe] }}</small>
      {% endif %}

      {% if current_data[k] %}
      <div id="leaflet-{{ form_id }}" _="install selectFromLeaflet(formId: '{{ form_id }}', loc: {
        lat: {{ current_data[k].lat }},
        lon: {{ current_data[k].lon }},
        radius: {{ current_data[k].radius }},
        display_name: '{{ current_data[k].display_name }}',
        zoom: {{ current_data[k].zoom }}
      })">
        <a class="leaflet-lock color-blue locked" href="">{{ L["Unlock"] }}</a>
      {% else %}
      <div id="leaflet-{{ form_id }}" _="install selectFromLeaflet(formId: '{{ form_id }}')">
      {% endif %}
        <div class="leaflet-map"></div>
        {% if request.view_args.get("object_type") == "projects" %}
        <label>
          {{ L["Radius"] }} <span class="leaflet-marker-radius"></span>
          <input type="number" class="input-radius" name="{{ field_name }}.radius" value="{{ current_data[k].radius or 100 }}"/>
        </label>
        {% endif %}
        <progress class="leaflet-loading"></progress>
        <div class="leaflet-controls hidden">
          <b class="leaflet-marker-name">-</b>
          <div class="grid-space-between">
            <a role="button" href="" class="leaflet-current-position">
              🎯 {{ L["Location"] }} <span class="leaflet-current-accuracy">{{ L["Unknown"]|lower }}</span>
            </a>
            <details class="dropdown leaflet-additional-markers" hx-disinherit="*">
              <summary>{{ L["Projects"] }}</summary>
              <ul dir="rtl">
              {% if request.view_args.get("object_type") == "projects" and object and object.id %}
                {% set current_project = object.id %}
              {% else %}
                {% set current_project = current_data.assigned_project or None %}
              {% endif %}
              {% for project_id, project_data in request.form_options.projects.items() if (project_data.permitted == True or project_id == current_project) and project_data.location %}
              <li>
                <label>
                  <input autocomplete="off" data-marker='{
                    "id": "marker-{{ loop.index }}",
                    "class": "leaflet-map-additional-marker {{ "hidden" if project_id != current_project }}",
                    "name": "{{ project_data.name }}",
                    "loc": {{ project_data.location|tojson }}
                  }' type="checkbox" {{ "checked" if project_id == current_project }} />
                  {{ project_data.name }}
                </label>
              </li>
              {% else %}
              <li>{{ L["No project available"] }}</li>
              {% endfor %}
              </ul>
            </details>
          </div>
          <input class="leaflet-search-query" type="text" placeholder="Suchbegriff">
        </div>
        <input type="hidden" class="input-lat" name="{{ field_name }}.lat" value="{{ current_data[k].lat or 0.0 }}"/>
        <input type="hidden" class="input-lon" name="{{ field_name }}.lon" value="{{ current_data[k].lon or 0.0 }}"/>
        <input type="hidden" class="input-display-name" name="{{ field_name }}.display_name" value="{{ current_data[k].display_name or '' }}"/>
      </div>
    </fieldset>

  {% elif v.type == "assets" %}

    <fieldset data-loading-disable>
      <legend>{{ L[v.title] }}</legend>
      {% if v.description %}
      <p>
        <small>{{ L[v.description|safe] }}</small>
      </p>
      {% endif %}
      {% if current_data[k] %}
        {% for asset in current_data[k] %}
        <details>
          <summary>{{ L["Attachment"] }} {{ loop.index }} - "{{ asset.filename }}"</summary>
          {% if asset.mime_type.startswith("image/") %}
          <div style="position: relative; display: inline-block;" _="on click
            put my outerHTML into #img-zoom
            add @open to #img-zoom
            add .dialog-open to body
          end">
            <img _="install lazyLoadImage" data-src="/asset/{{ asset.id }}" style="display: block; max-width: 100%;" alt="{{ L["Loading"] }} {{ asset.filename }}" />
            {% if asset.overlay %}{{ asset.overlay | safe }}{% endif %}
          </div>
          {% else %}
            <a href="/asset/{{ asset.id }}">Download {{ asset.filename }}</a>
          {% endif %}
        </details>
        {% endfor %}
        <input type="hidden" name="{{ field_name }}" value='{{ current_data[k]|tojson }}'/>
      {% else %}
      <p>
        <mark>{{ L["No files available"] }}</mark>
      </p>
      {% endif %}
    </fieldset>

  {% elif v.type == "textarea" %}

    <fieldset data-loading-disable>
      <label for="{{ form_id }}">{{ L[v.title] }}</label>
      <textarea {% if v.vault == 'true' %}_="install vaultField"{% endif %} {{ v.input_extra|safe }} id="{{ form_id }}" rows="10" name="{{ field_name }}">
        {%- if current_data[k] == None %}{{ v.default or '' }}{% else %}{{ current_data[k] }}{% endif -%}
      </textarea>
      {% if v.description %}
      <small>{{ L[v.description|safe] }}</small>
      {% endif %}
    </fieldset>

  {% elif v.type in ["date", "datetime-local"] %}

    <fieldset data-loading-disable>
      <label for="{{ form_id }}">{{ L[v.title] }}</label>
      <input {{ v.input_extra|safe }} id="{{ form_id }}"
        name="{{ field_name }}"
        type="{{ v.type }}"
        value="{% if current_data[k] == None %}{{ v.default or '' }}{% else %}{{ current_data[k] }}{% endif %}">
      {% if v.description %}
      <small>{{ L[v.description|safe] }}</small>
      {% endif %}
    </fieldset>

  {% elif v.type == "select:multi" or v.type == "select" %}

    <fieldset data-loading-disable>
      <label for="{{ form_id }}">{{ L[v.title] }}</label>
      <select {{ v.input_extra|safe }}
        {% if v.type == "select:multi" %}
        multiple
        size="5"
        {% endif %}
        name="{{ field_name }}"
        id="{{ form_id }}">
        {% for option in v.options %}
        <option value="{{ option.value }}" {{ "selected" if option.value in current_data[k] or option.value == "" and not current_data[k] }}>{{ option.name }}</option>
        {% endfor %}
      </select>
      {% if v.description %}
      <small>{{ L[v.description|safe] }}</small>
      {% endif %}
    </fieldset>

  {% elif v.type == "vault" %}

    {% if request.path == "/profile/" %}
    <details name="vault">
      <summary>{{ L[v.title] }}</summary>
      <div data-field-type="vault" _="install vaultConfig(formId: '{{ form_id }}', isInit: {{ "true" if current_data[k] else "false" }})">
        <input id="{{ form_id }}" type="hidden" {{ v.input_extra|safe }}
          name="{{ field_name }}"
          value='{{ current_data[k] or "" }}'/>
        {% if not current_data[k] %}
        <p>{{ L["Setup vault"] }}</p>
        <fieldset>
          <label>{{ L["Password"] }}</label>
          <input id="vault-password-{{ form_id }}" type="password" {{ v.input_extra|safe }} />
        </fieldset>
        <fieldset>
          <label>{{ L["Password confirmation"] }}</label>
          <input id="vault-password2-{{ form_id }}" type="password" {{ v.input_extra|safe }} />
        </fieldset>
        {% else %}
        <p>{{ L["Change password"] }}</p>
        <fieldset>
          <label>{{ L["Current password"] }}</label>
          <input id="vault-password-{{ form_id }}" type="password" {{ v.input_extra|safe }} />
        </fieldset>
        <fieldset>
          <label>{{ L["New password"] }}</label>
          <input id="vault-password-new-{{ form_id }}" type="password" {{ v.input_extra|safe }} />
        </fieldset>
        <fieldset>
          <label>{{ L["Repeat new password"] }}</label>
          <input id="vault-password-new2-{{ form_id }}" type="password" {{ v.input_extra|safe }} />
        </fieldset>
        {% endif %}
        <a id="vault-apply-{{ form_id }}" role="button">{{ L["Apply"] }}</a>
      </div>
    </details>
    {% endif %}

  {% elif v.type == "datalist" %}

    <fieldset data-loading-disable>
      <label for="{{ form_id }}">{{ L[v.title] }}</label>
      <input list="datalist-{{ form_id }}"
        name="{{ field_name }}"
        id="{{ form_id }}"
        value="{% if current_data[k] == None %}{{ v.default or '' }}{% else %}{{ current_data[k] }}{% endif %}" {{ v.input_extra|safe }}>
      <datalist
        id="datalist-{{ form_id }}">
        {% for option in v.options %}
        <option value="{{ option }}">
        {% endfor %}
      </datalist>
      {% if v.description %}
      <small>{{ L[v.description|safe] }}</small>
      {% endif %}
    </fieldset>

  {% elif (v.type == "users:multi" or v.type == "users") %}

    <fieldset data-loading-disable data-field-type="users">
      {% if not request.form_options.users %}
      <label for="{{ form_id }}">{{ L[v.title] }}</label>
      <p><mark>{{ L["There is no assignable user"] }}</mark></p>
      {% else %}
      <label for="{{ form_id }}">{{ L[v.title] }}</label>
      <select {{ v.input_extra|safe }}
        {% if v.type == "users:multi" %}
        multiple
        size="5"
        {% endif %}
        name="{{ field_name }}"
        id="{{ form_id }}">
        {% for user_id, user_data in request.form_options.users.items() %}
          <option value="{{ user_id }}" {{ "selected" if user_id in current_data[k]|string }}>{{ user_data.login }}</option>
        {% endfor %}
      </select>
      {% if v.description %}
      <small>{{ L[v.description|safe] }}</small>
      {% endif %}
    </fieldset>
    {% endif %}

  {% elif v.type == "list:text" or v.type == "list:number" %}

    <template id="list:item">
      <div class="item-{{ form_id }}">
        <input {{ v.input_extra|safe }}
          name="{{ field_name }}"
          type="{{ "text" if v.type == "list:text" else "number" }}"
          value="${value or ''}">
        <small>
          <a href="#" _="on click
            halt the event
            if length of .item-{{ form_id }} == 1
              set value of <input/> in closest .item-{{ form_id }} to ''
            else
              remove closest .item-{{ form_id }}
            end
          end">{{ L["Remove"] }}</a>
        </small>
      </div>
    </template>
    <fieldset data-loading-disable id="{{ form_id }}" _="init
      exit unless length of .item-{{ form_id }} in me == 0
      {% for list_value in current_data[k] or [] %}
        render #list:item with (value: '{{ list_value }}')
        put the result at the end of me
      {% else %}
        {% if v.default %}
        render #list:item with (value: '{{ v.default }}')
        {% else %}
        render #list:item
        put the result at the end of me
        {% endif %}
      {% endfor %}
      end
      on click from .add-list-item in me
        halt the event
        render #list:item
        put the result at the end of me
      end">
      <legend>{{ L[v.title] }} <a href="#" class="add-list-item">{{ L["Add"] }}</a></legend>
    </fieldset>
    {% if v.description %}
    <small>{{ L[v.description|safe] }}</small>
    {% endif %}

  {% elif v.type == "toggle" %}

    <fieldset data-loading-disable>
      <label>
        <input _="on change set value of #{{ form_id }} to my.checked as String end"
          type="checkbox"
          role="switch"
          {{ "checked" if current_data[k] == True }} />
          {{ L[v.title] }}
        <input id="{{ form_id }}"
          name="{{ field_name }}"
          value="{{ "true" if current_data[k] == True else "false" }}"
          type="hidden" {{ v.input_extra|safe }}>
      </label>
      {% if v.description %}
      <small>{{ L[v.description|safe] }}</small>
      {% endif %}
    </fieldset>

  {% elif v.type == "project" %}
    <fieldset data-loading-disable data-field-type="project">
    <label for="{{ form_id }}">{{ L[v.title] }}</label>
    <select {{ v.input_extra|safe }}
      name="{{ field_name }}"
      id="{{ form_id }}">
      {% for project_id, project_data in request.form_options.projects.items() %}
        {%- if project_data.permitted == True -%}
        <option value="{{ project_id }}" {{ "selected" if project_id == current_data[k]|string }}>{{ project_data.name }}</option>
        {% elif project_id == current_data[k] %}
        <option value="{{ project_id }}" selected>⚠️ {{ project_data.name }}</option>
        {%- endif -%}
      {% endfor %}
      <option value="" {{ "selected" if not current_data[k] or not request.form_options.projects }}>{{ L["No assignment"] }}</option>
    </select>
    {% if v.description %}
    <small>{{ L[v.description|safe] }}</small>
    {% endif %}
    </fieldset>

  {% endif %}
{% endfor %}
