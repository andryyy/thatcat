<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netto Rechner Willich</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .input-group { margin-bottom: 25px; }
        label { display: flex; justify-content: space-between; font-weight: 600; margin-bottom: 10px; color: #374151; }
        input[type="range"] { width: 100%; cursor: pointer; accent-color: #2563eb; }
        .val-display { color: #2563eb; }
        
        .result-box { 
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); 
            padding: 25px; border-radius: 12px; margin-top: 30px; text-align: center; border: 1px solid #bfdbfe;
        }
        .big-number { font-size: 3em; font-weight: 800; color: #1e3a8a; display: block; margin: 10px 0; }
        .sub-text { color: #64748b; font-size: 0.9em; }
        
        .chart-container { position: relative; height: 320px; width: 100%; margin-top: 40px; }
        
        .details { margin-top: 30px; border-top: 2px solid #f3f4f6; padding-top: 20px; }
        .row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95em; }
        .row.main { font-weight: bold; font-size: 1.1em; margin-top: 5px; margin-bottom: 15px; }
        .row.sub { padding-left: 20px; color: #666; font-size: 0.9em; }
        .row.total { font-weight: bold; border-top: 2px solid #e5e7eb; padding-top: 15px; margin-top: 15px; font-size: 1.2em; color: #111827; }
        
        h2 { margin-top: 0; color: #111827; }
        .badge { background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; vertical-align: middle; }
    </style>
</head>
<body>

<div class="container">
    <h2>IT-Freelancer Rechner <span class="badge">Willich Edition</span></h2>
    <p style="color: #666; font-size: 0.9em; margin-bottom: 25px;">
        Einstellungen: Stkl. II (Alleinerziehend), 1 Kind, Barmer (GKV), IHK, Gewerbesteuer Hebesatz 450%.
    </p>

    <div class="input-group">
        <label><span>Arbeitsstunden / Woche</span> <span id="val-hours" class="val-display">25 Std.</span></label>
        <input type="range" id="hours" min="10" max="60" step="1" value="25" oninput="calculate()">
    </div>

    <div class="input-group">
        <label><span>Stundensatz (Netto)</span> <span id="val-rate" class="val-display">90 €</span></label>
        <input type="range" id="rate" min="40" max="200" step="5" value="90" oninput="calculate()">
    </div>

    <div class="input-group">
        <label><span>Sonstige Ausgaben / Monat</span> <span id="val-expenses" class="val-display">175 €</span></label>
        <input type="range" id="expenses" min="0" max="2000" step="25" value="175" oninput="calculate()">
    </div>

    <div class="input-group">
        <label><span>IT-Haftpflicht / Monat</span> <span id="val-insurance" class="val-display">45 €</span></label>
        <input type="range" id="insurance" min="0" max="150" step="5" value="45" oninput="calculate()">
    </div>

    <div class="result-box">
        Echter monatlicher Gewinn (Netto)
        <span class="big-number" id="final-net">0 €</span>
        <span class="sub-text">Das landet wirklich auf Ihrem privaten Konto.</span>
    </div>

    <div class="chart-container">
        <canvas id="myChart"></canvas>
    </div>

    <div class="details">
        <div class="row"><span>Umsatz (Brutto):</span> <span id="res-revenue">0 €</span></div>
        <div class="row"><span>- Ausgaben (Büro + Haftpflicht):</span> <span id="res-expenses">0 €</span></div>
        <div class="row main"><span>= Gewinn vor Steuer:</span> <span id="res-profit">0 €</span></div>
        
        <div class="row sub"><i>Abgaben an Sozialversicherung:</i></div>
        <div class="row"><span>- Barmer (KV + Zusatz):</span> <span id="res-kv">0 €</span></div>
        <div class="row"><span>- Pflegeversicherung (1 Kind):</span> <span id="res-pv">0 €</span></div>
        
        <div class="row sub" style="margin-top:10px;"><i>Abgaben an Stadt & Staat:</i></div>
        <div class="row"><span>- Gewerbesteuer (Stadt Willich):</span> <span id="res-gewst">0 €</span></div>
        <div class="row"><span>- Einkommensteuer (Finanzamt):</span> <span id="res-est">0 €</span></div>
        <div class="row"><span>- IHK & Soli:</span> <span id="res-ihk">0 €</span></div>

        <div class="row total"><span>= Verfügbares Netto:</span> <span id="res-nettotal">0 €</span></div>
    </div>
</div>

<script>
    let myChart = null;

    function formatCurrency(num) {
        return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(num);
    }

    function calculateEst(taxableIncome) {
        // Steuerformel 2024 (Annäherung) für Einzelveranlagung
        // Grundfreibetrag ~11.604 ist in der Formel implizit
        // Progressionszonen
        if (taxableIncome <= 11604) return 0;
        
        let est = 0;
        let y = (taxableIncome - 11604) / 10000;
        
        if (taxableIncome <= 17005) {
            est = (983.21 * y + 1400) * y;
        } else if (taxableIncome <= 66760) {
            let z = (taxableIncome - 17005) / 10000;
            est = (206.05 * z + 2397) * z + 1025.38; // Werte grob an 2024 angepasst
        } else if (taxableIncome <= 277825) {
            est = 0.42 * taxableIncome - 9960; 
        } else {
            est = 0.45 * taxableIncome - 18307;
        }
        return est;
    }

    function calculate() {
        // 1. Inputs
        let hours = parseFloat(document.getElementById('hours').value);
        let rate = parseFloat(document.getElementById('rate').value);
        let expMisc = parseFloat(document.getElementById('expenses').value);
        let expIns = parseFloat(document.getElementById('insurance').value);
        let totalExp = expMisc + expIns;

        // UI Update
        document.getElementById('val-hours').innerText = hours + " Std.";
        document.getElementById('val-rate').innerText = rate + " €";
        document.getElementById('val-expenses').innerText = expMisc + " €";
        document.getElementById('val-insurance').innerText = expIns + " €";

        // 2. Betriebliche Rechnung (Jahr)
        let yearlyRevenue = hours * 4.33 * 12 * rate; 
        let yearlyExpenses = totalExp * 12;
        let yearlyProfit = yearlyRevenue - yearlyExpenses;

        // 3. Gewerbesteuer Willich (Hebesatz 450%)
        // Freibetrag 24.500
        let gewSt = 0;
        let messbetrag = 0;
        if (yearlyProfit > 24500) {
            let gewerbeErtrag = yearlyProfit - 24500;
            messbetrag = gewerbeErtrag * 0.035;
            gewSt = messbetrag * 4.5; // Hebesatz 450%
        }

        // 4. IHK (Grundbeitrag + Umlage)
        let ihkYear = 180; // Grundbeitrag geschätzt
        if (yearlyProfit > 25000) ihkYear += (yearlyProfit * 0.0015); // Umlage

        // 5. Sozialversicherung (Barmer + PV)
        // BBG KV/PV 2024 = 5175€/Monat = 62.100€/Jahr
        let svBase = Math.min(Math.max(yearlyProfit, 1178*12), 62100);
        
        // Sätze: KV 14,6% + 2,19% Zusatz (geschätzt 24/25) = 16.79%
        // PV: 3,4% (1 Kind) -> Selbstzahler voll
        let kvYear = svBase * 0.1679;
        let pvYear = svBase * 0.034;
        let svTotalYear = kvYear + pvYear;

        // 6. Einkommensteuer (ESt)
        // Zu versteuerndes Einkommen ermitteln
        // Abzug Vorsorgeaufwendungen (Basisabsicherung KV/PV ist steuerfrei)
        // Wir nehmen pauschal ca 96% der KV/PV als absetzbar an + Basisvorsorge
        let absetzbareVorsorge = svTotalYear * 0.96; 
        
        // Entlastungsbetrag Alleinerziehende
        let entlastungAlleinerziehend = 4260;
        
        // Kinderfreibetrag (2024: 6612€ für beide Eltern, halber Anteil = 3306€ + Erziehung 1464€ = 4770€ ca.)
        // Da geschieden: Ihnen steht der halbe KFB zu (ca. 3306) plus Erziehungsfreibetrag (1464) = 4770 EUR.
        // Bei hohem Einkommen (Günstigerprüfung) wird das Kindergeld verrechnet, aber der Freibetrag mindert die Steuerlast.
        let kinderFreibetrag = 4770; 

        let zvE = yearlyProfit - absetzbareVorsorge - entlastungAlleinerziehend - kinderFreibetrag;
        
        // Steuer berechnen
        let estYear = calculateEst(Math.max(0, zvE));

        // Gewerbesteueranrechnung!
        // Ermäßigung um 4,0-faches des Messbetrags
        let anrechnung = messbetrag * 4.0;
        // Die Steuer darf nicht unter 0 fallen
        estYear = Math.max(0, estYear - anrechnung);

        // Soli (fällt meist weg wegen hoher Freigrenze ~18k Steuerlast, wir berechnen ihn pauschal wenn ESt sehr hoch)
        let soliYear = 0;
        if (estYear > 18130) {
            soliYear = estYear * 0.055; 
        }

        // 7. Monatliches Netto
        let monthlyNet = (yearlyProfit - gewSt - estYear - soliYear - svTotalYear - ihkYear) / 12;

        // Display Values (Monthly)
        document.getElementById('res-revenue').innerText = formatCurrency(yearlyRevenue / 12);
        document.getElementById('res-expenses').innerText = formatCurrency(totalExp);
        document.getElementById('res-profit').innerText = formatCurrency(yearlyProfit / 12);
        
        document.getElementById('res-kv').innerText = formatCurrency(kvYear / 12);
        document.getElementById('res-pv').innerText = formatCurrency(pvYear / 12);
        
        document.getElementById('res-gewst').innerText = formatCurrency(gewSt / 12);
        document.getElementById('res-est').innerText = formatCurrency(estYear / 12);
        document.getElementById('res-ihk').innerText = formatCurrency((ihkYear + soliYear) / 12);
        
        document.getElementById('res-nettotal').innerText = formatCurrency(monthlyNet);
        document.getElementById('final-net').innerText = formatCurrency(monthlyNet);

        // Update Chart
        updateChart(monthlyNet, (estYear+soliYear)/12, (kvYear+pvYear)/12, gewSt/12, totalExp + ihkYear/12);
    }

    function updateChart(net, tax, sv, gewst, exp) {
        if (myChart) myChart.destroy();
        const ctx = document.getElementById('myChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Mein Netto', 'Eink.Steuer', 'Sozialvers.', 'GewSt Willich', 'Ausgaben'],
                datasets: [{
                    label: 'Monatliche Verteilung',
                    data: [net, tax, sv, gewst, exp],
                    backgroundColor: [
                        '#2563eb', // Netto (Blau)
                        '#f59e0b', // Steuer (Orange)
                        '#10b981', // SV (Grün)
                        '#ef4444', // GewSt (Rot)
                        '#6b7280'  // Ausgaben (Grau)
                    ],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});
                            }
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true, grid: { display: true, color: '#f3f4f6' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    calculate();
</script>
</body>
</html>
